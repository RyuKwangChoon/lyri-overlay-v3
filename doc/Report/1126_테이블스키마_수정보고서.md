# ðŸ”§ í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ì ê²€ ë° ìˆ˜ì • ì™„ë£Œ ë³´ê³ ì„œ

**ìž‘ì„±ì¼**: 2025-11-26  
**ì ê²€ í•­ëª©**: server/index.js ì¿¼ë¦¬ë¬¸ vs V2 ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

---

## ðŸ”´ ë°œê²¬ëœ ë¬¸ì œ

### 1ï¸âƒ£ í…Œì´ë¸”ëª… ë¶ˆì¼ì¹˜

| ê¸°ëŠ¥ | V3 ì½”ë“œ (ìž˜ëª»ë¨) | V2 ìŠ¤í‚¤ë§ˆ (ì˜¬ë°”ë¦„) |
|------|--------------|---------|
| ë©”ì‹œì§€ ì €ìž¥ | `messages` | `tb_overlay_message` |
| ê³µì§€ ì €ìž¥ | `notices` | `tb_overlay_notice` |
| íŠ¸ëž™ ê´€ë¦¬ | `tracks` | `tb_tracks` |
| í˜„ìž¬ ìž¬ìƒ | `tracks` (ì—†ìŒ) | `tb_now_playing` |

### 2ï¸âƒ£ ì»¬ëŸ¼ëª…/êµ¬ì¡° ë¶ˆì¼ì¹˜

#### tb_overlay_message INSERT
```javascript
// âŒ ìž˜ëª»ëœ V3 ì½”ë“œ
INSERT INTO messages (text, role, created_at) VALUES (?, ?, ?)

// âœ… ì˜¬ë°”ë¥¸ V2 ìŠ¤í‚¤ë§ˆ
INSERT INTO tb_overlay_message 
(text, role, imoji, overlay_date, broadcast_ymd, seq, priority, 
 type, session_id, repeatable, with_promo, sent)
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'N')
```

#### tb_overlay_notice INSERT
```javascript
// âŒ ìž˜ëª»ëœ V3 ì½”ë“œ
INSERT INTO notices (text, priority, created_at) VALUES (?, ?, NOW())

// âœ… ì˜¬ë°”ë¥¸ V2 ìŠ¤í‚¤ë§ˆ
INSERT INTO tb_overlay_notice (text, slot, is_active) VALUES (?, ?, ?)
```

#### tb_tracks INSERT
```javascript
// âŒ ìž˜ëª»ëœ V3 ì½”ë“œ (track_noê°€ order)
INSERT INTO tracks (title, artist, duration, `order`, created_at) VALUES (?, ?, ?, ?, NOW())

// âœ… ì˜¬ë°”ë¥¸ V2 ìŠ¤í‚¤ë§ˆ
INSERT INTO tb_tracks 
(title, artist, album, file_original, file_stored, file_path, file_ext, 
 duration_sec, track_no, status, created_at)
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 'ready', NOW())
```

#### tb_now_playing (ì™„ì „ ëˆ„ë½ â†’ ì¶”ê°€ ìž‘ì„±)
```javascript
// âŒ V3ì—ëŠ” ì—†ì—ˆìŒ (tb_now_playingì„ tracksì—ì„œ ì²˜ë¦¬)

// âœ… ì˜¬ë°”ë¥¸ V2 ìŠ¤í‚¤ë§ˆ
UPDATE tb_now_playing
SET track_id=?, track_title=?, file_path=?, duration_sec=?, 
    current_pos_sec=?, is_playing=?, emotion=?, repeat_mode=?, updated_at=NOW()
WHERE id=1  // (1 ROW ONLY)
```

---

## âœ… ìˆ˜ì • ì™„ë£Œ í•­ëª©

### 1ï¸âƒ£ POST /message/save
**ë³€ê²½ì‚¬í•­**:
- í…Œì´ë¸”: `messages` â†’ `tb_overlay_message`
- ì»¬ëŸ¼ í™•ëŒ€: 3ê°œ â†’ 11ê°œ
  - ì¶”ê°€: `imoji`, `overlay_date`, `broadcast_ymd`, `seq`, `priority`, `type`, `session_id`, `repeatable`, `with_promo`
- ìžë™ `sent='Y'` ë§ˆí‚¹ ì¶”ê°€ (ì¤‘ë³µ ì†¡ì¶œ ë°©ì§€)

```javascript
// ìˆ˜ì • í›„
app.post('/message/save', async (req, res) => {
  const {
    text, role = 'assistant', imoji = null, overlay_date = null, 
    broadcast_ymd = null, seq = null, priority = 10, type = 'chat',
    session_id = 'live', repeatable = 'N', with_promo = 'N'
  } = req.body;

  await connection.query(
    `INSERT INTO tb_overlay_message
     (text, role, imoji, overlay_date, broadcast_ymd, seq, priority, 
      type, session_id, repeatable, with_promo, sent)
     VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'N')`,
    [text, role, imoji, overlay_date, broadcast_ymd, seq, priority, 
     type, session_id, repeatable, with_promo]
  );

  // ì¦‰ì‹œ sent='Y' ë§ˆí‚¹
  await connection.query(
    `UPDATE tb_overlay_message SET sent='Y', delivered_at=NOW() WHERE id=?`,
    [result.insertId]
  );
});
```

### 2ï¸âƒ£ POST /notice/update
**ë³€ê²½ì‚¬í•­**:
- í…Œì´ë¸”: `notices` â†’ `tb_overlay_notice`
- ì»¬ëŸ¼ ë³€ê²½: `priority` â†’ `slot` (title/top/bottom)
- `is_active` íŒŒë¼ë¯¸í„° ì¶”ê°€

```javascript
// ìˆ˜ì • í›„
app.post('/notice/update', async (req, res) => {
  const { notice, slot = 'top', is_active = 'N' } = req.body;

  await connection.query(
    `INSERT INTO tb_overlay_notice (text, slot, is_active) VALUES (?, ?, ?)`,
    [notice, slot, is_active]
  );
});
```

### 3ï¸âƒ£ POST /tracks/update
**ë³€ê²½ì‚¬í•­**:
- í…Œì´ë¸”: `tracks` â†’ `tb_tracks`
- ì»¬ëŸ¼ í™•ëŒ€: 4ê°œ â†’ 11ê°œ
  - ì¶”ê°€: `album`, `file_original`, `file_stored`, `file_path`, `file_ext`, `status`
- `duration` â†’ `duration_sec`, `order` â†’ `track_no`
- ê¸°ì¡´ íŠ¸ëž™ ì‚­ì œ ì œê±° (ë°ì´í„° ë³´ì¡´)

```javascript
// ìˆ˜ì • í›„
app.post('/tracks/update', async (req, res) => {
  for (const track of tracks) {
    await connection.query(
      `INSERT INTO tb_tracks 
       (title, artist, album, file_original, file_stored, file_path, 
        file_ext, duration_sec, track_no, status, created_at)
       VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 'ready', NOW())`,
      [track.title, track.artist, track.album, track.file_original,
       track.file_stored, track.file_path, track.file_ext, track.duration,
       track.order]
    );
  }
});
```

### 4ï¸âƒ£ POST /nowplaying/update (ì™„ì „ ìž¬ìž‘ì„±)
**ë³€ê²½ì‚¬í•­**:
- í…Œì´ë¸”: `tracks` (status='playing') â†’ `tb_now_playing` (1 ROW ONLY)
- ë¡œì§: INSERT OR UPDATE (ê¸°ì¡´ row ìžˆìœ¼ë©´ UPDATE, ì—†ìœ¼ë©´ INSERT)
- ì¶”ê°€ ì»¬ëŸ¼: `started_at`, `emotion`, `repeat_mode`, `album`

```javascript
// ìˆ˜ì • í›„
app.post('/nowplaying/update', async (req, res) => {
  const [[countRow]] = await connection.query(`SELECT COUNT(*) AS cnt FROM tb_now_playing`);
  const exists = countRow.cnt > 0;

  if (exists) {
    // UPDATE ê¸°ì¡´ row
    await connection.query(
      `UPDATE tb_now_playing
       SET track_id=?, track_title=?, file_path=?, duration_sec=?, current_pos_sec=?,
           is_playing=?, emotion=?, repeat_mode=?, updated_at=NOW()
       WHERE id=1`,
      [track_id, track_title, file_path, duration_sec, current_pos_sec, is_playing, emotion, repeat_mode]
    );
  } else {
    // INSERT ìƒˆ row
    await connection.query(
      `INSERT INTO tb_now_playing
       (track_id, track_title, file_path, duration_sec, current_pos_sec, is_playing, emotion, repeat_mode, started_at, updated_at)
       VALUES (?, ?, ?, ?, ?, ?, ?, ?, NOW(), NOW())`,
      [track_id, track_title, file_path, duration_sec, current_pos_sec, is_playing, emotion, repeat_mode]
    );
  }
});
```

### 5ï¸âƒ£ NowPlaying ì›Œì»¤ ê°œì„ 
**ë³€ê²½ì‚¬í•­**:
- ì¿¼ë¦¬: `tracks WHERE status='playing'` â†’ `tb_now_playing LIMIT 1`
- ì§„í–‰ ì‹œê°„ ê³„ì‚°: íƒ€ìž„ìŠ¤íƒ¬í”„ ê¸°ë°˜ â†’ ë°ì´í„°ë² ì´ìŠ¤ `current_pos_sec` ê¸°ë°˜
- íŠ¸ëž™ ì¢…ë£Œ ë¡œì§: 3ê°€ì§€ repeat ëª¨ë“œ ì™„ë²½ ì§€ì›

```javascript
// ìˆ˜ì • í›„ ì›Œì»¤ ë¡œì§
const startNowPlayingWorker = () => {
  nowPlayingWorker = setInterval(async () => {
    const [rows] = await connection.query(
      `SELECT np.*, t.duration_sec as track_duration
       FROM tb_now_playing np
       LEFT JOIN tb_tracks t ON t.id = np.track_id
       LIMIT 1`
    );

    if (!rows.length) return;

    const np = rows[0];
    const trackDuration = np.duration_sec || np.track_duration || 0;
    const currentPos = np.current_pos_sec || 0;
    const repeatMode = np.repeat_mode || 'none';

    if (currentPos < trackDuration - 3) {
      // ðŸŽµ ê³¡ ì§„í–‰ ì¤‘: pos += 3
      await connection.query(
        `UPDATE tb_now_playing SET current_pos_sec = current_pos_sec + 3, updated_at = NOW() WHERE id = ?`,
        [np.id]
      );
    } else {
      // â¹ ê³¡ ì¢…ë£Œ: repeat ëª¨ë“œ ì²˜ë¦¬
      // - 'none': is_playing='N'
      // - 'one': current_pos_sec=0 (ìž¬ì‹œìž‘)
      // - 'all': ë‹¤ìŒ íŠ¸ëž™ ë¡œë“œ
    }
  }, NOWPLAYING_INTERVAL);
};
```

---

## ðŸ“Š ë³€ê²½ ì „í›„ ë¹„êµ

| í•­ëª© | ë³€ê²½ ì „ | ë³€ê²½ í›„ |
|------|--------|--------|
| Message í…Œì´ë¸”ëª… | `messages` | `tb_overlay_message` âœ… |
| Message ì»¬ëŸ¼ | 3ê°œ | 11ê°œ âœ… |
| Notice í…Œì´ë¸”ëª… | `notices` | `tb_overlay_notice` âœ… |
| Notice ì»¬ëŸ¼ | 2ê°œ | 4ê°œ âœ… |
| Track í…Œì´ë¸”ëª… | `tracks` | `tb_tracks` âœ… |
| Track ì»¬ëŸ¼ | 4ê°œ | 11ê°œ âœ… |
| NowPlaying | ì—†ìŒ | `tb_now_playing` âœ… |
| ì›Œì»¤ ì§„í–‰ ê³„ì‚° | íƒ€ìž„ìŠ¤íƒ¬í”„ | DB í•„ë“œ âœ… |
| Repeat ëª¨ë“œ ì§€ì› | ì œí•œì  | ì™„ë²½ ì§€ì› âœ… |

---

## ðŸ§ª í…ŒìŠ¤íŠ¸ ê¶Œìž¥ì‚¬í•­

### 1. Message ì €ìž¥ í…ŒìŠ¤íŠ¸
```bash
curl -X POST http://localhost:8787/message/save \
  -H "Content-Type: application/json" \
  -d '{
    "text": "í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€",
    "role": "brian",
    "priority": 5,
    "type": "chat",
    "session_id": "live"
  }'
```

### 2. Notice ì €ìž¥ í…ŒìŠ¤íŠ¸
```bash
curl -X POST http://localhost:8787/notice/update \
  -H "Content-Type: application/json" \
  -d '{
    "notice": "ì¤‘ìš” ê³µì§€ì‚¬í•­",
    "slot": "top",
    "is_active": "Y"
  }'
```

### 3. NowPlaying ì—…ë°ì´íŠ¸ í…ŒìŠ¤íŠ¸
```bash
curl -X POST http://localhost:8787/nowplaying/update \
  -H "Content-Type: application/json" \
  -d '{
    "track_id": 1,
    "track_title": "Beautiful Music",
    "duration_sec": 180,
    "current_pos_sec": 0,
    "is_playing": "Y",
    "repeat_mode": "all"
  }'
```

### 4. ë°ì´í„°ë² ì´ìŠ¤ ê²€ì¦
```sql
-- Message í™•ì¸
SELECT id, text, role, priority, type, sent FROM tb_overlay_message ORDER BY id DESC LIMIT 5;

-- Notice í™•ì¸
SELECT id, text, slot, is_active FROM tb_overlay_notice ORDER BY id DESC LIMIT 5;

-- Track í™•ì¸
SELECT id, title, artist, duration_sec, track_no FROM tb_tracks ORDER BY track_no LIMIT 5;

-- NowPlaying í™•ì¸
SELECT * FROM tb_now_playing;
```

---

## âœ¨ ìµœì¢… ìƒíƒœ

- âœ… **ëª¨ë“  í…Œì´ë¸”ëª… í†µì¼** (V2 ìŠ¤í‚¤ë§ˆ ì¤€ìˆ˜)
- âœ… **ëª¨ë“  ì»¬ëŸ¼ í†µì¼** (ëˆ„ë½ëœ í•„ë“œ ì¶”ê°€)
- âœ… **ì›Œì»¤ ë¡œì§ ê°œì„ ** (ë°ì´í„°ë² ì´ìŠ¤ ê¸°ë°˜ ì§„í–‰ ì‹œê°„)
- âœ… **Repeat ëª¨ë“œ ì™„ë²½ ì§€ì›** (none/one/all)
- âœ… **1 ROW ONLY ì›ì¹™ ì ìš©** (tb_now_playing)
- âœ… **ë°ì´í„° ë³´ì¡´ ì •ì±…** (ë©”ì‹œì§€/ê³µì§€ ì‚­ì œ ê¸ˆì§€)

**V3 server/index.jsëŠ” ì´ì œ V2 ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆì™€ ì™„ë²½í•˜ê²Œ í˜¸í™˜ë©ë‹ˆë‹¤!** ðŸŽ‰

